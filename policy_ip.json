{
  "policy_version": "1.0.3",
  "engine": "oracle-19c",
  "mode": "static_code_scan",
  "owner_schemas": ["CPPGS"],
  "approved_tablespaces": {
    "tables": ["TBS_DESP_01_DAT"],
    "indexes": ["TBS_DESP_01_IDX"]
  },

  "runtime": {
    "policy_load_order": [
      "embedded_block:/* POLICY_BUNDLE_JSON_START */.../* POLICY_BUNDLE_JSON_END */",
      "knowledge_file:policy_ip.json",
      "knowledge_file:policy_ip.txt"
    ],
    "input_normalization": {
      "strip_prefixes": ["You said:", "Copilot said:", "Validator", "Razones clave", "Cómo corregir"],
      "code_fences_only": true,
      "collapse_spaces": true,
      "preserve_newlines": true
    }
  },

  "reporting": {
    "fail_on_severity": ["BLOCKER"],
    "score_weights": { "BLOCKER": 100, "MAJOR": 20, "MINOR": 5 },
    "approval_max_score": 20,
    "verdict_labels": { "pass": "CUMPLE", "fail": "NO CUMPLE" },
    "output": {
      "header_prefix": "Veredicto: ",
      "include_fix": false,
      "include_code_samples": false,
      "pass_message": "Desarrollo válido para pasar a producción.",
      "fail_issue_template": "• Regla: {rule.id} — {rule.title}\n  Manual: {standard.doc_id}, Sección {standard.section}, pág. {standard.page}\n  Riesgo: {rule.risk}\n  Alternativa sugerida: {rule.alt_text}"
    },
    "pre_checks": {
      "require_code_payload": true,
      "on_missing_code": "Veredicto: NO CUMPLE\n• Regla: INPUT-NO-CODE — El adjunto no expone contenido de código\n  Manual: STD-GEN-CODE-2025, Sección 1.1, pág. 3\n  Riesgo: Imposible auditar evidencia técnica.\n  Alternativa sugerida: Adjuntar archivo de texto/código o URL RAW accesible."
    }
  },

  "file_match": [
    "**/*.sql", "**/*.ddl", "**/*.pkg", "**/*.pks", "**/*.pkb",
    "**/*.ps1",
    "**/*.prm", "**/*.xml", "**/*.ipc",
    "**/*.txt"
  ],

  "namespaces": [
    {
      "id": "oracle_sql",
      "applies_to": ["**/*.sql", "**/*.ddl", "**/*.pkg", "**/*.pks", "**/*.pkb"],
      "rules": [
        {
          "id": "ORA-LOGGING-001",
          "title": "Prohibido NOLOGGING en objetos permanentes",
          "severity": "BLOCKER",
          "detect": { "regex": ["\\bCREATE\\b[\\s\\S]*\\bNOLOGGING\\b", "\\bALTER\\b[\\s\\S]*\\bNOLOGGING\\b"] },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "3.1.2", "page": 17 },
          "risk": "Pérdida de redo y recuperación incompleta.",
          "alt_text": "Usar LOGGING. Si hay carga masiva, ventanear y dimensionar REDO/TEMP; usar APPEND con LOGGING."
        },
        {
          "id": "ORA-COMPRESS-002",
          "title": "COMPRESS fuera de whitelist",
          "severity": "BLOCKER",
          "detect": { "regex": ["\\bCOMPRESS\\b(?![\\s\\S]*FOR\\s+OLTP)"] },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "3.1.5", "page": 20 },
          "risk": "Penaliza DML y afecta latencia.",
          "alt_text": "Permitir solo COMPRESS FOR OLTP en tablas aprobadas según patrón R/W."
        },
        {
          "id": "ORA-PARALLEL-003",
          "title": "PARALLEL sin justificación aprobada",
          "severity": "MAJOR",
          "detect": { "regex": ["\\bPARALLEL\\b|/\\*\\+\\s*PARALLEL\\("] },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "4.3.1", "page": 31 },
          "risk": "Contención CPU, skew y presión en SGA/TEMP.",
          "alt_text": "Controlar con Resource Manager; evidenciar con EXPLAIN PLAN y AWR en ventana dedicada."
        },
        {
          "id": "ORA-SELECTSTAR-004",
          "title": "SELECT * sobre objetos sensibles",
          "severity": "BLOCKER",
          "detect": { "regex": ["SELECT\\s+\\*\\s+FROM\\s+(sensitive\\.|pii\\.|audit\\.)"] },
          "standard_ref": { "doc_id": "STD-DATA-GOV-2025", "section": "5.2.3", "page": 44 },
          "risk": "Exposición de PII y contratos frágiles.",
          "alt_text": "Seleccionar columnas mínimas y aplicar masking/column-level security."
        },
        {
          "id": "ORA-INDEXPK-005",
          "title": "PK/FK sin índice",
          "severity": "BLOCKER",
          "detect": { "ast": "constraint_without_backing_index" },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "3.2.1", "page": 22 },
          "risk": "Bloqueos y FTS en validación y joins.",
          "alt_text": "Índice único para PK y no único por cada FK; validar con EXPLAIN PLAN."
        },
        {
          "id": "ORA-TABLESPACE-006",
          "title": "Tablespace no aprobado",
          "severity": "BLOCKER",
          "detect": { "regex": ["TABLESPACE\\s+(?!TBS_DESP_01_DAT\\b|TBS_DESP_01_IDX\\b)\\w+"] },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "2.4.2", "page": 14 },
          "risk": "Storage disperso y RTO/RPO no garantizados.",
          "alt_text": "Alinear a TBS aprobados o abrir RFC de capacidad."
        },
        {
          "id": "ORA-DYNEXEC-007",
          "title": "EXECUTE IMMEDIATE no parametrizado",
          "severity": "BLOCKER",
          "detect": { "regex": ["EXECUTE\\s+IMMEDIATE[\\s\\S]*\\|\\|"] },
          "standard_ref": { "doc_id": "STD-SEC-PLSQL-2025", "section": "6.1.1", "page": 53 },
          "risk": "SQL injection y privilegios excesivos.",
          "alt_text": "Bind variables y listas blancas contra diccionario."
        },
        {
          "id": "ORA-NOCACHE-008",
          "title": "NOCACHE/CACHE inapropiado en secuencias",
          "severity": "MAJOR",
          "detect": { "regex": ["CREATE\\s+SEQUENCE[\\s\\S]*\\bNOCACHE\\b|CREATE\\s+SEQUENCE[\\s\\S]*\\bCACHE\\s+\\d+\\b"] },
          "standard_ref": { "doc_id": "STD-DB-ORCL-2025", "section": "3.3.4", "page": 25 },
          "risk": "Hot blocks o contención en diccionario.",
          "alt_text": "Usar CACHE moderado en OLTP (p.ej. 100–1000) y nocache solo por requisito auditado."
        }
      ]
    },

    {
      "id": "powershell",
      "applies_to": ["**/*.ps1"],
      "rules": [
        {
          "id": "PS-EXEC-001",
          "title": "ExecutionPolicy Bypass/Unrestricted",
          "severity": "BLOCKER",
          "detect": { "regex": ["-ExecutionPolicy\\s+(Bypass|Unrestricted)"] },
          "standard_ref": { "doc_id": "STD-SEC-PS1-2025", "section": "2.1", "page": 6 },
          "risk": "Ejecución de scripts no confiables.",
          "alt_text": "RemoteSigned/AllSigned y firma de scripts; verificación en CI."
        },
        {
          "id": "PS-SECRETS-002",
          "title": "Credenciales en claro o SecureString mal usado",
          "severity": "BLOCKER",
          "detect": { "regex": ["Password\\s*=\\s*['\"][^'\"]+['\"]|ConvertTo-SecureString\\s+['\"][^'\"]+['\"]\\s+-AsPlainText\\s+-Force"] },
          "standard_ref": { "doc_id": "STD-SEC-PS1-2025", "section": "3.2", "page": 11 },
          "risk": "Exfiltración de secretos.",
          "alt_text": "SecretManagement/Vault y variables protegidas del runner."
        },
        {
          "id": "PS-SQLCMD-003",
          "title": "Invoke-Sqlcmd a objetos sensibles sin controles",
          "severity": "MAJOR",
          "detect": { "regex": ["Invoke-Sqlcmd[\\s\\S]*SELECT\\s+\\*\\s+FROM\\s+(sensitive\\.|pii\\.)"] },
          "standard_ref": { "doc_id": "STD-DATA-GOV-2025", "section": "5.2.3", "page": 44 },
          "risk": "Lectura masiva de PII.",
          "alt_text": "Columnas explícitas, roles mínimos y masking."
        }
      ]
    },

    {
      "id": "ipc_powercenter",
      "applies_to": ["**/*.prm", "**/*.xml", "**/*.ipc", "**/*.txt"],
      "rules": [
        {
          "id": "IPC-CONN-001",
          "title": "Conexiones con password en claro",
          "severity": "BLOCKER",
          "detect": { "regex": ["Password\\s*=\\s*[^\\s#;]+"] },
          "standard_ref": { "doc_id": "STD-ETL-IPC-2025", "section": "2.3.1", "page": 9 },
          "risk": "Compromiso de credenciales.",
          "alt_text": "Vault/keystore y variables cifradas del scheduler."
        },
        {
          "id": "IPC-LOG-002",
          "title": "Nivel de log no conforme en PROD",
          "severity": "MAJOR",
          "detect": { "regex": ["TraceLevel\\s*=\\s*(DEBUG|VERBOSE)"] },
          "standard_ref": { "doc_id": "STD-ETL-IPC-2025", "section": "4.1.2", "page": 21 },
          "risk": "Volumen de logs y fuga de datos.",
          "alt_text": "INFO en PROD; DEBUG solo en ventana controlada."
        }
      ]
    }
  ]
}
