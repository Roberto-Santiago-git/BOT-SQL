{
  "policy_version": "1.0.5",
  "engine": "oracle-19c",
  "mode": "static_code_scan",
  "owner_schemas": ["CPPGS"],
  "approved_tablespaces": { "tables": ["TBS_DESP_01_DAT"], "indexes": ["TBS_DESP_01_IDX"] },

  "runtime": {
    "policy_load_order": [
      "embedded_block:/* POLICY_BUNDLE_JSON_START */.../* POLICY_BUNDLE_JSON_END */",
      "knowledge_file:policy_ip.json",
      "knowledge_file:policy_ip.txt"
    ],
    "input_normalization": {
      "filename_lowercase": true,
      "accept_multiple_filenames": true,
      "split_on_whitespace_commas": true,
      "glob_patterns_enabled": true,
      "code_fences_only": false,
      "collapse_spaces": true,
      "preserve_newlines": true,
      "max_bytes_per_file": 1048576
    },
    "language_inference": {
      "enabled_for_txt_and_unknown_ext": true,
      "priority": ["oracle_sql", "powershell", "ipc_powercenter"],
      "signals": {
        "oracle_sql": [
          "CREATE\\s+(OR\\s+REPLACE\\s+)?(PACKAGE|PROCEDURE|FUNCTION|TRIGGER)\\b",
          "\\bBEGIN\\b[\\s\\S]*\\bEND\\s*;?",
          "\\bCREATE\\s+TABLE\\b|\\bALTER\\s+TABLE\\b|\\bEXECUTE\\s+IMMEDIATE\\b"
        ],
        "powershell": [
          "\\bInvoke-Sqlcmd\\b|\\bImport-Module\\b|\\bWrite-Host\\b",
          "\\bParam\\s*\\(|\\$\\w+\\s*=",
          "-ExecutionPolicy\\s+(Bypass|Unrestricted)"
        ],
        "ipc_powercenter": [
          "^\\[DBSession\\]", "^TraceLevel\\s*=", "^UserName\\s*=", "\\.prm\\b",
          "<POWERMART\\b", "<REPOSITORY\\b", "<FOLDER\\b", "<WORKFLOW\\b", "<SESSION\\b", "<TRANSFORMATION\\b"
        ]
      },
      "on_ambiguous": "INPUT-UNKNOWN-LANG"
    }
  },

  "reporting": {
    "fail_on_severity": ["BLOCKER"],
    "score_weights": { "BLOCKER": 100, "MAJOR": 20, "MINOR": 5 },
    "approval_max_score": 20,
    "verdict_labels": { "pass": "CUMPLE", "fail": "NO CUMPLE", "no_analysis": "SIN-ANÁLISIS" },
    "output": {
      "header_prefix": "Veredicto: ",
      "include_fix": false,
      "include_code_samples": false,
      "pass_message": "",
      "fail_issue_template": "[{rule.severity}] {rule.id}: {rule.title}"
    },
    "pre_checks": {
      "require_code_payload": true,
      "allow_txt_as_code": true,
      "allow_unknown_ext": true,
      "on_missing_code": "Veredicto: SIN-ANÁLISIS\n[error] INPUT-NO-CODE: El adjunto no expone contenido de código o el texto no contiene código detectable.",
      "on_unknown_lang": "Veredicto: SIN-ANÁLISIS\n[info] INPUT-UNKNOWN-LANG: No se pudo inferir si el archivo es Oracle/PowerShell/IPC."
    }
  },

  "rule_suppressions": ["CPPGS-OWNER", "CPPGS-GRANT"],
  "rules_overrides": [
    { "id": "CPPGS-OWNER", "enabled": false, "severity": "INFO", "message": "Suprimida por configuración" },
    { "id": "CPPGS-GRANT", "enabled": false, "severity": "INFO", "message": "Suprimida por configuración" }
  ],

  "file_match": [
    "**/*.sql", "**/*.ddl", "**/*.pkg", "**/*.pks", "**/*.pkb",
    "**/*.ps1",
    "**/*.prm", "**/*.xml", "**/*.ipc",
    "**/*.txt"
  ],

  "namespaces": [
    {
      "id": "oracle_sql",
      "applies_to": ["**/*.sql", "**/*.ddl", "**/*.pkg", "**/*.pks", "**/*.pkb", "**/*.txt", "**/*"],
      "rules": [
        { "id": "ORA-LOGGING-001", "title": "Prohibido NOLOGGING en objetos permanentes", "severity": "BLOCKER",
          "detect": { "regex": ["\\bCREATE\\b[\\s\\S]*\\bNOLOGGING\\b", "\\bALTER\\b[\\s\\S]*\\bNOLOGGING\\b"] }
        },
        { "id": "ORA-COMPRESS-002", "title": "COMPRESS fuera de whitelist", "severity": "BLOCKER",
          "detect": { "regex": ["\\bCOMPRESS\\b(?![\\s\\S]*FOR\\s+OLTP)"] }
        },
        { "id": "ORA-PARALLEL-003", "title": "PARALLEL sin justificación aprobada", "severity": "MAJOR",
          "detect": { "regex": ["\\bPARALLEL\\b|/\\*\\+\\s*PARALLEL\\("] }
        },
        { "id": "ORA-SELECTSTAR-004", "title": "SELECT * sobre objetos sensibles", "severity": "BLOCKER",
          "detect": { "regex": ["SELECT\\s+\\*\\s+FROM\\s+(sensitive\\.|pii\\.|audit\\.)"] }
        },
        { "id": "ORA-INDEXPK-005", "title": "PK/FK sin índice", "severity": "BLOCKER",
          "detect": { "ast": "constraint_without_backing_index" }
        },
        { "id": "ORA-TABLESPACE-006", "title": "Tablespace no aprobado", "severity": "BLOCKER",
          "detect": { "regex": ["TABLESPACE\\s+(?!TBS_DESP_01_DAT\\b|TBS_DESP_01_IDX\\b)\\w+"] }
        },
        { "id": "ORA-DYNEXEC-007", "title": "EXECUTE IMMEDIATE no parametrizado", "severity": "BLOCKER",
          "detect": { "regex": ["EXECUTE\\s+IMMEDIATE[\\s\\S]*\\|\\|"] }
        }
      ]
    },

    {
      "id": "powershell",
      "applies_to": ["**/*.ps1", "**/*.txt", "**/*"],
      "rules": [
        { "id": "PS-EXEC-001", "title": "ExecutionPolicy Bypass/Unrestricted", "severity": "BLOCKER",
          "detect": { "regex": ["-ExecutionPolicy\\s+(Bypass|Unrestricted)"] }
        },
        { "id": "PS-SECRETS-002", "title": "Credenciales en claro o SecureString mal usado", "severity": "BLOCKER",
          "detect": { "regex": ["Password\\s*=\\s*['\"][^'\"]+['\"]|ConvertTo-SecureString\\s+['\"][^'\"]+['\"]\\s+-AsPlainText\\s+-Force"] }
        },
        { "id": "PS-SQLCMD-003", "title": "Invoke-Sqlcmd a objetos sensibles sin controles", "severity": "MAJOR",
          "detect": { "regex": ["Invoke-Sqlcmd[\\s\\S]*SELECT\\s+\\*\\s+FROM\\s+(sensitive\\.|pii\\.)"] }
        }
      ]
    },

    {
      "id": "ipc_powercenter",
      "applies_to": ["**/*.prm", "**/*.xml", "**/*.ipc", "**/*.txt", "**/*"],
      "rules": [
        { "id": "IPC-CONN-001", "title": "Conexiones con password en claro", "severity": "BLOCKER",
          "detect": { "regex": ["Password\\s*=\\s*[^\\s#;]+"] }
        },
        { "id": "IPC-LOG-002", "title": "Nivel de log no conforme en PROD", "severity": "MAJOR",
          "detect": { "regex": ["TraceLevel\\s*=\\s*(DEBUG|VERBOSE)"] }
        }
      ]
    }
  ]
}

