{
  "policy_version": "1.0.0",
  "engine": "powershell-5+",
  "mode": "static_code_scan",
  "file_match": ["**/*.ps1"],
  "reporting": {
    "fail_on_severity": ["BLOCKER"],
    "verdict_labels": { "pass": "CUMPLE", "fail": "NO CUMPLE" }
  },
  "namespaces": [
    {
      "id": "ps1",
      "applies_to": ["**/*.ps1"],
      "rules": [
        {
          "id": "REQUIRE_CLEAR_HOST",
          "description": "El script debe iniciar con Clear-Host.",
          "type": "requires_when",
          "when": "^(?!\\s*#).+",
          "require": "^\\s*Clear-Host\\b",
          "flags": "im",
          "severity": "MINOR",
          "message": "Agrega Clear-Host al inicio del script."
        },
        {
          "id": "REQUIRE_HEADER_COMMENT",
          "description": "Encabezado de metadatos (descripción/versión/ejecución).",
          "type": "regex_required_any",
          "patterns": [
            "^\\s*#\\s*Descripcion|^\\s*#\\s*Descripción",
            "^\\s*#\\s*Version|^\\s*#\\s*Versión",
            "^\\s*#\\s*(Workflow|Ejecucion|Ejecución)"
          ],
          "flags": "im",
          "severity": "MAJOR",
          "message": "Incluye encabezado con descripción, versión y ejecución."
        },
        {
          "id": "BAN_NESTED_POWERSHELL",
          "description": "No usar shells secundarios.",
          "type": "regex_forbidden_any",
          "patterns": [
            "\\bStart-Process\\s+(?:powershell|pwsh)\\b",
            "\\bpowershell\\.exe\\s+-File\\b",
            "\\bpwsh\\s+-File\\b"
          ],
          "flags": "i",
          "severity": "BLOCKER",
          "message": "Evita lanzar shells secundarios; usa un solo .ps1 principal."
        },
        {
          "id": "BAN_INVOKE_EXPRESSION",
          "description": "Evitar Invoke-Expression/iex.",
          "type": "regex_forbidden",
          "pattern": "\\b(Invoke-Expression|iex)\\b",
          "flags": "i",
          "severity": "MAJOR",
          "message": "No uses Invoke-Expression por seguridad/mantenibilidad."
        }
      ]
    }
  ]
}

